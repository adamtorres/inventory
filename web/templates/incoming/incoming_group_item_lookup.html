{% extends "base_with_navpanel.html" %}
{% load static %}
{% load humanize %}

{% block title %}Incoming Group Item Lookup{% endblock %}

{% block styles %}
<style type="text/css">
#calculation-div .col-sm-1 input {
    width: 100%;
}
label {
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" id="lookup-content">
    <p>The lookup page.</p>

    <table style="display: none;" class="filtered-item-template-container">
        <tr class="filtered-item-link filtered-item-top" data-id="nope" id="filtered-item-template">
            <td class="border" data-field="parent">__parent__</td>
            <td class="border" data-field="item">__item__</td>
            <td class="border" data-field="comment">__comment__</td>
            <td class="border" data-field="item_comment">__item_comment__</td>
            <td class="border" data-field="delivered_quantity">__delivered_quantity__</td>
            <td class="border" data-field="total_weight">__total_weight__</td>
            <td class="border" data-field="pack_quantity">__pack_quantity__</td>
            <td class="border" data-field="unit_size">__unit_size__</td>
            <td class="border" data-field="pack_price">__pack_price__</td>
            <td class="border" data-field="pack_tax">__pack_tax__</td>
            <td class="border" data-field="extended_price">__extended_price__</td>
        </tr>
    </table>
    <div id="filter-controls">
        <div class="row">
            <div class="col">
                <label for="filter-quantity">Quantity:</label>
                <input type="text" id="filter-quantity" class="filter-input" />
            </div>
            <div class="col">
                <label for="filter-unit-size">Unit size:</label>
                <input type="text" id="filter-unit-size" class="filter-input" />
            </div>
            <div class="col">
                <label for="filter-item">Item name:</label>
                <input type="text" id="filter-item" class="filter-input" />
            </div>
            <div class="col">
                <label for="filter-comment">Comment:</label>
                <input type="text" id="filter-comment" class="filter-input" />
            </div>
        </div>
    </div>
    <div id="calculation-div">
        <p>
            Selected item
        </p>
        <div class="row">
            <div class="row">
                <div class="col">
                    <label for="calc-item">Item: </label>
                    <span id="calc-item">[item name]</span>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label for="calc-comment">Comment: </label>
                    <span id="calc-comment">[comment on the line item]</span>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label for="calc-item-comment">Item Comment: </label>
                    <span id="calc-item-comment">[comment on the item itself]</span>
                </div>
            </div>
        </div>
        <div class="row row-cols-5">
            <div class="col col-sm-1">
                <label for="calc-quantity">Quantity</label>
            </div>
            <div class="col col-sm-1">
                <label for="calc-pack-quantity">Pack Quantity</label>
            </div>
            <div class="col col-sm-1">
                <label for="calc-unit-size">Unit Size</label>
            </div>
            <div class="col col-sm-2">
                <label for="calc-price">Price</label>
            </div>
            <div class="col col-sm-2">
                <label for="calc-pack-price" id="calc-pack-price-label">Pack Price</label>
            </div>
            <div class="col col-sm-2">
                <label for="calc-unit-price" id="calc-unit-price-label">Unit Price</label>
            </div>
            <div class="col col-sm-2">
                <label for="calc-weight">Weight</label>
            </div>
        </div>
        <div class="row row-cols-5">
            <div class="col col-sm-1">
                <span id="calc-quantity"></span>
            </div>
            <div class="col col-sm-1">
                <span id="calc-pack-quantity"></span>
            </div>
            <div class="col col-sm-1">
                <span id="calc-unit-size"></span>
            </div>
            <div class="col col-sm-2">
                <span id="calc-price"></span>
            </div>
            <div class="col col-sm-2">
                <span id="calc-pack-price"></span>
            </div>
            <div class="col col-sm-2">
                <span id="calc-unit-price"></span>
            </div>
            <div class="col col-sm-2">
                <span id="calc-weight"></span>
            </div>
        </div>
        <div class="row">
            <div class="col" id="calculated-results">
                <table style="display: none;">
                    <tr id="per_unit_row_template">
                        <td data-field="units">__units__</td>
                        <td data-field="cost_for_the_units">__cost_for_the_units__</td>
                    </tr>
                </table>
                <table>
                    <thead>
                    <tr>
                        <th>Units</th>
                        <th>Price</th>
                    </tr>
                    </thead>
                    <tbody id="calculated-per-unit-prices">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <pre id="on-page-log">
Log.
    </pre>

<table>
    <thead>
        <tr>
            <th class="border">Incoming Group</th>
            <th class="border">Item</th>
            <th class="border">Comment</th>
            <th class="border">Item Comment</th>
            <th class="border">Delivered Quantity</th>
            <th class="border">Total Weight</th>
            <th class="border">Pack Quantity</th>
            <th class="border">Unit Size</th>
            <th class="border">Pack Price</th>
            <th class="border">Pack Tax</th>
            <th class="border">Extended Price</th>
        </tr>
    </thead>
    <tbody id="result-table-body">
    </tbody>
</table>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{% static 'js/date_str.js' %}"></script>
<script src="{% static 'js/on_page_log.js' %}"></script>
<script src="{% static 'js/live_filter.js' %}"></script>
<script type="text/javascript">
filter_url = "{% url 'inc_live_filter_incomingitems' %}";
filter_fields = ["delivered_quantity", "total_weight", "pack_quantity", "unit_size", "pack_price", "pack_tax", "extended_price", "comment", "item_comment", "parent", "item"];
remove_decimals = ["delivered_quantity", "total_weight", "pack_quantity", "pack_price", "pack_tax", "extended_price"];
filter_results_div_id = "result-table-body";
filter_input_fields = [
    {element: "#filter-quantity", ajax_var: "quantity"},
    {element: "#filter-unit-size", ajax_var: "unit_size"},
    {element: "#filter-item", ajax_var: "item"},
    {element: "#filter-comment", ajax_var: "comment"},
];
filter_result_fields = [
    {element: "data-field='item'", destination_field_id: "calc-item"},
    {element: "data-field='item_comment'", destination_field_id: "calc-item-comment"},
    {element: "data-field='comment'", destination_field_id: "calc-comment"},
    {element: "data-field='delivered_quantity'", destination_field_id: "calc-quantity"},
    {element: "data-field='pack_quantity'", destination_field_id: "calc-pack-quantity"},
    {element: "data-field='unit_size'", destination_field_id: "calc-unit-size"},
    {element: "data-field='extended_price'", destination_field_id: "calc-price"},
    {element: "data-field='pack_price'", destination_field_id: "calc-pack-price"},
    {element: "data-field='total_weight'", destination_field_id: "calc-weight"},
];
function round(v) {
    return Math.round(v * 100) / 100;
}
$( document ).ready(function() {
    let w = $(window);
    w.on("resize", function() {
        let w = $(window);
        let window_height = w.height();
        let content_obj = $("#lookup-content");
        let content_offset = content_obj.offset().top - w.scrollTop();
        content_obj.css("max-height", window_height - content_offset);
    });
    w.trigger("resize");
    w.on(filter_requested_event_name, function() {
        $("#calculation-div").addClass("d-none");
    });
    w.on(filter_results_populated_event_name, function() {

    });
    w.on(item_selected_event_name, function() {
        var weight = parseFloat($("#calc-weight").text());
        var pack_quantity = parseFloat($("#calc-pack-quantity").text());
        var quantity = parseFloat($("#calc-quantity").text());
        var pack_price = parseFloat($("#calc-pack-price").text());
        var total_price = parseFloat($("#calc-price").text());
        var pack_price_per_weight = 0;
        var price_per_unit = total_price / quantity / pack_quantity;
        $("#calc-unit-price").text(round(price_per_unit));

        if (weight > 0) {
            pack_price_per_weight = pack_price;
            price_per_unit = weight / quantity / pack_quantity * pack_price_per_weight;
            pack_price = round(price_per_unit * pack_quantity);
            $("#calc-pack-price").text(pack_price);
        }
        let total_units = pack_quantity * quantity;
        row_template = $(`#per_unit_row_template`);
        per_unit_table = $(`#calculated-per-unit-prices`);
        per_unit_table.empty();
        for(i = 0; i < total_units; i++) {
            let item_clone = row_template.clone();
            item_clone.attr('id', null);
            item_clone.find('[data-field]').each(function() {
                let e = $(this);
                let key = e.data('field');
                if (key === "units") {
                    e.text(round(i+1));
                }
                if (key === "cost_for_the_units") {
                    e.text(round(price_per_unit * (i+1)));
                }
            });
            // item_clone.removeClass("hidden");
            per_unit_table.append(item_clone);
        }
        $("#calculation-div").removeClass("d-none");
        //
        // calculated-per-unit-prices
    })
});

</script>
{% endblock %}
